import{c as k,o as C,w as s,d as l,e as a,p as i,f,h as c,ax as p,t as u,aM as g,i as T,aP as _,ay as h,az as x,aO as y,g as U,R as P,aR as A,S as b}from"./index-Byq_qIU-.js";import{b as D}from"./route-block-B_A1xBdJ.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as w,a as d}from"./VRow-YsLEDygf.js";import{b as v,V as N}from"./VDataTable-DsiE_ZoA.js";import{V as E}from"./VChip-BWGeb_Ua.js";import{V as z}from"./VForm-BgoMm207.js";import{V as O}from"./VContainer-D0C_tlqJ.js";import"./VPagination-D0xA3492.js";import"./VList-CtbhIv0H.js";import"./ssrBoot-yz0QkJx1.js";import"./VDivider-Bg9SXvB8.js";import"./VMenu-CgFCL-Q8.js";const F={name:"AdminUsers",data(){return{users:[],loading:!1,saving:!1,deleting:!1,creating:!1,search:"",roleFilter:null,editDialog:!1,deleteDialog:!1,createDialog:!1,editingUser:null,userToDelete:null,editFormValid:!1,createFormValid:!1,showPasswords:!1,showCreatePassword:!1,showEditPassword:!1,newUser:{account:"",email:"",password:"",role:"user"},snackbar:{show:!1,message:"",color:"success"},headers:[{title:"帳號",key:"account",sortable:!0},{title:"電子郵件",key:"email",sortable:!0},{title:"角色",key:"role",sortable:!0},{title:"建立時間",key:"createdAt",sortable:!0},{title:"操作",key:"actions",sortable:!1}],roleOptions:[{title:"一般使用者",value:"user"},{title:"管理員",value:"admin"}],rules:{required:o=>!!o||"此欄位為必填",account:o=>/^[a-zA-Z0-9]{4,20}$/.test(o)||"帳號只能包含英文字母和數字，長度4-20字元",email:o=>/.+@.+\..+/.test(o)||"請輸入有效的電子郵件地址",password:o=>!o||o.length>=4&&o.length<=20||"密碼長度必須在4-20字元之間"}}},computed:{filteredUsers(){let o=this.users;return this.roleFilter&&(o=o.filter(e=>e.role===this.roleFilter)),o},userCount(){return this.users.filter(o=>o.role==="user").length},adminCount(){return this.users.filter(o=>o.role==="admin").length},todayCount(){const o=new Date;return o.setHours(0,0,0,0),this.users.filter(e=>{const n=new Date(e.createdAt);return n.setHours(0,0,0,0),n.getTime()===o.getTime()}).length}},mounted(){this.loadUsers()},methods:{async loadUsers(){this.loading=!0;try{const o=await b.getAllUsers();this.users=o.data.result}catch(o){console.error("載入使用者失敗:",o),this.showSnackbar("載入使用者失敗","error")}finally{this.loading=!1}},refreshUsers(){this.loadUsers()},openCreateDialog(){this.createDialog=!0,this.resetNewUser()},closeCreateDialog(){this.createDialog=!1,this.resetNewUser(),this.showCreatePassword=!1},resetNewUser(){this.newUser={account:"",email:"",password:"",role:"user"},this.$refs.createForm&&this.$refs.createForm.resetValidation()},async createUser(){var o,e;if(this.$refs.createForm.validate()){this.creating=!0;try{const n=await b.createUser(this.newUser);this.users.unshift(n.data.result),this.closeCreateDialog(),this.showSnackbar("使用者建立成功","success")}catch(n){console.error("建立使用者失敗:",n),this.showSnackbar(((e=(o=n.response)==null?void 0:o.data)==null?void 0:e.message)||"建立使用者失敗","error")}finally{this.creating=!1}}},editUser(o){this.editingUser={...o,password:""},this.editDialog=!0,this.showEditPassword=!1},async saveUser(){var o,e;if(this.$refs.editForm.validate()){this.saving=!0;try{const n={...this.editingUser};n.password||delete n.password,await b.updateUser(this.editingUser._id,n);const V=this.users.findIndex(t=>t._id===this.editingUser._id);V!==-1&&(this.users[V]={...this.editingUser},n.password&&delete this.users[V].password),this.editDialog=!1,this.showSnackbar("使用者資料更新成功","success")}catch(n){console.error("更新使用者失敗:",n),this.showSnackbar(((e=(o=n.response)==null?void 0:o.data)==null?void 0:e.message)||"更新使用者失敗","error")}finally{this.saving=!1}}},confirmDelete(o){this.userToDelete=o,this.deleteDialog=!0},async deleteUser(){var o,e;this.deleting=!0;try{await b.deleteUser(this.userToDelete._id),this.users=this.users.filter(n=>n._id!==this.userToDelete._id),this.deleteDialog=!1,this.showSnackbar("使用者刪除成功","success")}catch(n){console.error("刪除使用者失敗:",n),this.showSnackbar(((e=(o=n.response)==null?void 0:o.data)==null?void 0:e.message)||"刪除使用者失敗","error")}finally{this.deleting=!1}},formatDate(o){return new Date(o).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},showSnackbar(o,e="success"){this.snackbar={show:!0,message:o,color:e}}}},B={class:"d-flex align-center justify-space-between"},I={class:"text-h4 font-weight-bold text-primary mb-2"},R={class:"text-h4 font-weight-bold text-primary"},H={class:"text-h4 font-weight-bold text-success"},j={class:"text-h4 font-weight-bold text-error"},L={class:"text-h4 font-weight-bold text-info"},M={class:"d-flex align-center"},W={class:"text-white font-weight-bold"},Z={class:"font-weight-medium"},G={class:"text-caption text-medium-emphasis"},J={class:"d-flex align-center"},K={class:"d-flex align-center"},Q={class:"d-flex gap-2"},X={class:"text-body-1 mb-4"},Y={class:"text-error"},$={class:"d-flex align-center"};function ee(o,e,n,V,t,m){return C(),k(O,{class:"pa-3",fluid:""},{default:s(()=>[l(w,{class:"mb-1"},{default:s(()=>[l(d,{cols:"12"},{default:s(()=>[a("div",B,[a("div",null,[a("h1",I,[l(f,{class:"me-3",size:"32"},{default:s(()=>e[20]||(e[20]=[i("mdi-account-group")])),_:1,__:[20]}),e[21]||(e[21]=i(" 使用者管理 "))]),e[22]||(e[22]=a("p",{class:"text-body-1 text-medium-emphasis mt-3"}," 管理系統中的所有使用者帳號 ",-1))]),l(c,{class:"px-6 mb-2",color:"primary",elevation:"2","prepend-icon":"mdi-plus",size:"large",onClick:m.openCreateDialog},{default:s(()=>e[23]||(e[23]=[i(" 新增使用者 ")])),_:1,__:[23]},8,["onClick"])])]),_:1})]),_:1}),l(w,{class:"mb-6"},{default:s(()=>[l(d,{cols:"12",md:"3"},{default:s(()=>[l(p,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"primary",size:"48"},{default:s(()=>e[24]||(e[24]=[i("mdi-account-multiple")])),_:1,__:[24]}),a("h3",R,u(t.users.length),1),e[25]||(e[25]=a("p",{class:"text-body-2 text-medium-emphasis"},"總使用者數",-1))]),_:1,__:[25]})]),_:1}),l(d,{cols:"12",md:"3"},{default:s(()=>[l(p,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"success",size:"48"},{default:s(()=>e[26]||(e[26]=[i("mdi-account")])),_:1,__:[26]}),a("h3",H,u(m.userCount),1),e[27]||(e[27]=a("p",{class:"text-body-2 text-medium-emphasis"},"一般使用者",-1))]),_:1,__:[27]})]),_:1}),l(d,{cols:"12",md:"3"},{default:s(()=>[l(p,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"error",size:"48"},{default:s(()=>e[28]||(e[28]=[i("mdi-shield-crown")])),_:1,__:[28]}),a("h3",j,u(m.adminCount),1),e[29]||(e[29]=a("p",{class:"text-body-2 text-medium-emphasis"},"管理員",-1))]),_:1,__:[29]})]),_:1}),l(d,{cols:"12",md:"3"},{default:s(()=>[l(p,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"info",size:"48"},{default:s(()=>e[30]||(e[30]=[i("mdi-calendar-today")])),_:1,__:[30]}),a("h3",L,u(m.todayCount),1),e[31]||(e[31]=a("p",{class:"text-body-2 text-medium-emphasis"},"今日新增",-1))]),_:1,__:[31]})]),_:1})]),_:1}),l(w,null,{default:s(()=>[l(d,{cols:"12",md:"6"},{default:s(()=>[l(g,{modelValue:t.search,"onUpdate:modelValue":e[0]||(e[0]=r=>t.search=r),clearable:"",density:"comfortable",label:"搜尋使用者","prepend-inner-icon":"mdi-magnify",variant:"outlined"},null,8,["modelValue"])]),_:1}),l(d,{cols:"12",md:"3"},{default:s(()=>[l(v,{modelValue:t.roleFilter,"onUpdate:modelValue":e[1]||(e[1]=r=>t.roleFilter=r),clearable:"",density:"comfortable",items:t.roleOptions,label:"角色篩選",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),l(d,{class:"d-flex align-center",cols:"12",md:"3"},{default:s(()=>[l(c,{class:"w-100 mb-6",color:"primary",height:"45px",loading:t.loading,"prepend-icon":"mdi-refresh",variant:"outlined",onClick:m.refreshUsers},{default:s(()=>e[32]||(e[32]=[i(" 重新整理 ")])),_:1,__:[32]},8,["loading","onClick"])]),_:1})]),_:1}),l(w,null,{default:s(()=>[l(d,{cols:"12"},{default:s(()=>[l(p,{elevation:"2"},{default:s(()=>[l(N,{class:"elevation-0",density:"default",headers:t.headers,hover:"",items:m.filteredUsers,loading:t.loading,search:t.search},{"item.account":s(({item:r})=>[a("div",M,[l(T,{class:"me-3",color:"primary",size:"32"},{default:s(()=>[a("span",W,u(r.account.charAt(0).toUpperCase()),1)]),_:2},1024),a("div",null,[a("div",Z,u(r.account),1),a("div",G,"ID: "+u(r._id.slice(-6)),1)])])]),"item.email":s(({item:r})=>[a("div",J,[l(f,{class:"me-2",color:"grey",size:"16"},{default:s(()=>e[33]||(e[33]=[i("mdi-email")])),_:1,__:[33]}),i(" "+u(r.email),1)])]),"item.role":s(({item:r})=>[l(E,{class:"font-weight-medium",color:r.role==="admin"?"error":"success",size:"small",variant:"elevated"},{default:s(()=>[l(f,{class:"me-1",size:"16"},{default:s(()=>[i(u(r.role==="admin"?"mdi-shield-crown":"mdi-account"),1)]),_:2},1024),i(" "+u(r.role==="admin"?"管理員":"一般使用者"),1)]),_:2},1032,["color"])]),"item.createdAt":s(({item:r})=>[a("div",K,[l(f,{class:"me-2",color:"grey",size:"16"},{default:s(()=>e[34]||(e[34]=[i("mdi-calendar")])),_:1,__:[34]}),i(" "+u(m.formatDate(r.createdAt)),1)])]),"item.actions":s(({item:r})=>[a("div",Q,[l(c,{class:"me-1",color:"warning",icon:"mdi-pencil",size:"small",title:"編輯使用者",variant:"tonal",onClick:S=>m.editUser(r)},null,8,["onClick"]),l(c,{color:"error",disabled:r.role==="admin",icon:"mdi-delete",size:"small",title:"刪除使用者",variant:"tonal",onClick:S=>m.confirmDelete(r)},null,8,["disabled","onClick"])])]),_:1},8,["headers","items","loading","search"])]),_:1})]),_:1})]),_:1}),l(_,{modelValue:t.createDialog,"onUpdate:modelValue":e[8]||(e[8]=r=>t.createDialog=r),"max-width":"500px",persistent:""},{default:s(()=>[l(p,null,{default:s(()=>[l(h,{class:"text-h5 font-weight-bold pa-6 pb-4"},{default:s(()=>[l(f,{class:"me-3",color:"primary",size:"28"},{default:s(()=>e[35]||(e[35]=[i("mdi-account-plus")])),_:1,__:[35]}),e[36]||(e[36]=i(" 新增使用者 "))]),_:1,__:[36]}),l(x,{class:"pa-6 pt-0"},{default:s(()=>[l(z,{ref:"createForm",modelValue:t.createFormValid,"onUpdate:modelValue":e[7]||(e[7]=r=>t.createFormValid=r)},{default:s(()=>[l(w,null,{default:s(()=>[l(d,{cols:"12",md:"6"},{default:s(()=>[l(g,{modelValue:t.newUser.account,"onUpdate:modelValue":e[2]||(e[2]=r=>t.newUser.account=r),density:"comfortable",label:"帳號 *","prepend-inner-icon":"mdi-account",rules:[t.rules.required,t.rules.account],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(d,{cols:"12",md:"6"},{default:s(()=>[l(g,{modelValue:t.newUser.email,"onUpdate:modelValue":e[3]||(e[3]=r=>t.newUser.email=r),density:"comfortable",label:"電子郵件 *","prepend-inner-icon":"mdi-email",rules:[t.rules.required,t.rules.email],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(d,{cols:"12",md:"6"},{default:s(()=>[l(g,{modelValue:t.newUser.password,"onUpdate:modelValue":e[5]||(e[5]=r=>t.newUser.password=r),density:"comfortable",label:"密碼 *","prepend-inner-icon":"mdi-lock",rules:[t.rules.required,t.rules.password],type:t.showCreatePassword?"text":"password",variant:"outlined"},{"append-inner":s(()=>[l(c,{icon:"mdi-eye",size:"small",variant:"text",onClick:e[4]||(e[4]=r=>t.showCreatePassword=!t.showCreatePassword)})]),_:1},8,["modelValue","rules","type"])]),_:1}),l(d,{cols:"12",md:"6"},{default:s(()=>[l(v,{modelValue:t.newUser.role,"onUpdate:modelValue":e[6]||(e[6]=r=>t.newUser.role=r),density:"comfortable",items:t.roleOptions,label:"角色 *","prepend-inner-icon":"mdi-shield",rules:[t.rules.required],variant:"outlined"},null,8,["modelValue","items","rules"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(y,{class:"pa-6 pt-0"},{default:s(()=>[l(U),l(c,{class:"px-6",color:"grey",variant:"outlined",onClick:m.closeCreateDialog},{default:s(()=>e[37]||(e[37]=[i(" 取消 ")])),_:1,__:[37]},8,["onClick"]),l(c,{class:"px-6",color:"primary",disabled:!t.createFormValid,loading:t.creating,onClick:m.createUser},{default:s(()=>e[38]||(e[38]=[i(" 新增 ")])),_:1,__:[38]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(_,{modelValue:t.editDialog,"onUpdate:modelValue":e[16]||(e[16]=r=>t.editDialog=r),"max-width":"500px",persistent:""},{default:s(()=>[l(p,null,{default:s(()=>[l(h,{class:"text-h5 font-weight-bold pa-6 pb-4"},{default:s(()=>[l(f,{class:"me-3",color:"warning",size:"28"},{default:s(()=>e[39]||(e[39]=[i("mdi-account-edit")])),_:1,__:[39]}),e[40]||(e[40]=i(" 編輯使用者 "))]),_:1,__:[40]}),t.editingUser?(C(),k(x,{key:0,class:"pa-6 pt-0"},{default:s(()=>[l(z,{ref:"editForm",modelValue:t.editFormValid,"onUpdate:modelValue":e[14]||(e[14]=r=>t.editFormValid=r)},{default:s(()=>[l(w,null,{default:s(()=>[l(d,{cols:"12",md:"6"},{default:s(()=>[l(g,{modelValue:t.editingUser.account,"onUpdate:modelValue":e[9]||(e[9]=r=>t.editingUser.account=r),density:"comfortable",label:"帳號","prepend-inner-icon":"mdi-account",rules:[t.rules.required,t.rules.account],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(d,{cols:"12",md:"6"},{default:s(()=>[l(g,{modelValue:t.editingUser.email,"onUpdate:modelValue":e[10]||(e[10]=r=>t.editingUser.email=r),density:"comfortable",label:"電子郵件","prepend-inner-icon":"mdi-email",rules:[t.rules.required,t.rules.email],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(d,{cols:"12",md:"6"},{default:s(()=>[l(g,{modelValue:t.editingUser.password,"onUpdate:modelValue":e[12]||(e[12]=r=>t.editingUser.password=r),density:"comfortable",label:"新密碼 (留空則不修改)","prepend-inner-icon":"mdi-lock",rules:[t.rules.password],type:t.showEditPassword?"text":"password",variant:"outlined"},{"append-inner":s(()=>[l(c,{icon:"mdi-eye",size:"small",variant:"text",onClick:e[11]||(e[11]=r=>t.showEditPassword=!t.showEditPassword)})]),_:1},8,["modelValue","rules","type"])]),_:1}),l(d,{cols:"12",md:"6"},{default:s(()=>[l(v,{modelValue:t.editingUser.role,"onUpdate:modelValue":e[13]||(e[13]=r=>t.editingUser.role=r),density:"comfortable",items:t.roleOptions,label:"角色","prepend-inner-icon":"mdi-shield",rules:[t.rules.required],variant:"outlined"},null,8,["modelValue","items","rules"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})):P("",!0),l(y,{class:"pa-6 pt-0"},{default:s(()=>[l(U),l(c,{class:"px-6",color:"grey",variant:"outlined",onClick:e[15]||(e[15]=r=>t.editDialog=!1)},{default:s(()=>e[41]||(e[41]=[i(" 取消 ")])),_:1,__:[41]}),l(c,{class:"px-6",color:"primary",disabled:!t.editFormValid,loading:t.saving,onClick:m.saveUser},{default:s(()=>e[42]||(e[42]=[i(" 儲存 ")])),_:1,__:[42]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(_,{modelValue:t.deleteDialog,"onUpdate:modelValue":e[18]||(e[18]=r=>t.deleteDialog=r),"max-width":"400px",persistent:""},{default:s(()=>[l(p,null,{default:s(()=>[l(h,{class:"text-h5 font-weight-bold pa-6 pb-4 text-center"},{default:s(()=>[l(f,{class:"me-3",color:"error",size:"32"},{default:s(()=>e[43]||(e[43]=[i("mdi-alert-circle")])),_:1,__:[43]}),e[44]||(e[44]=i(" 確認刪除 "))]),_:1,__:[44]}),l(x,{class:"pa-6 pt-0 text-center"},{default:s(()=>{var r;return[a("p",X,[e[45]||(e[45]=i(" 確定要刪除使用者 ")),a("strong",Y,u((r=t.userToDelete)==null?void 0:r.account),1),e[46]||(e[46]=i(" 嗎？ "))]),e[47]||(e[47]=a("p",{class:"text-body-2 text-medium-emphasis"}," 此操作無法復原，請謹慎操作。 ",-1))]}),_:1,__:[47]}),l(y,{class:"pa-6 pt-0"},{default:s(()=>[l(U),l(c,{class:"px-6",color:"grey",variant:"outlined",onClick:e[17]||(e[17]=r=>t.deleteDialog=!1)},{default:s(()=>e[48]||(e[48]=[i(" 取消 ")])),_:1,__:[48]}),l(c,{class:"px-6",color:"error",loading:t.deleting,onClick:m.deleteUser},{default:s(()=>e[49]||(e[49]=[i(" 刪除 ")])),_:1,__:[49]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(A,{modelValue:t.snackbar.show,"onUpdate:modelValue":e[19]||(e[19]=r=>t.snackbar.show=r),color:t.snackbar.color,location:"top",timeout:3e3},{default:s(()=>[a("div",$,[l(f,{class:"me-3"},{default:s(()=>[i(u(t.snackbar.color==="success"?"mdi-check-circle":"mdi-alert-circle"),1)]),_:1}),i(" "+u(t.snackbar.message),1)])]),_:1},8,["modelValue","color"])]),_:1})}typeof D=="function"&&D(F);const pe=q(F,[["render",ee]]);export{pe as default};
