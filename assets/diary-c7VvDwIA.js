import{P as pe,r as f,Q as me,b as ge,l as F,o as k,d as a,w as s,e as o,p as b,f as w,h as V,aN as E,ax as z,t as u,R as ve,F as Y,n as fe,c as xe,j as ye,aO as be,k as d,ay as q,az as J,aP as Q,g as G,aQ as K}from"./index-KC8Fu95-.js";import{u as we,c as Ve,a as he,b as A,e as T}from"./index.esm-CFF9iISF.js";import{d as M}from"./diary-D1b7W4TM.js";import{b as X}from"./route-block-B_A1xBdJ.js";import{V as U,a as x}from"./VRow-Js2kYVxX.js";import{a as Z}from"./VSelect-CxcFQ9up.js";import{V as _e}from"./VDataTable-Di4asx99.js";import{V as ee}from"./VChip-PMzwQLBL.js";import{V as ke}from"./VContainer-C62bWApN.js";import{V as Se}from"./VForm-Ci8mZxrG.js";import{V as te}from"./VDivider-CgzjqxB6.js";import{V as De}from"./VTextarea-BJrplP7S.js";import{V as $e}from"./VSwitch-BTnxWqe0.js";import"./VList-DJyRj5q_.js";import"./ssrBoot-CCrmWCSd.js";import"./VMenu-B01AtdRN.js";import"./VPagination-FJlCxQ8A.js";const Ce={class:"d-flex align-center justify-space-between"},Fe={class:"text-h4 font-weight-bold text-orange-darken-4 mb-1"},ze={class:"d-flex align-center gap-4 pa-1"},Te={class:"d-flex flex-column"},Me={class:"text-body-2 font-weight-medium"},Pe={class:"text-caption text-medium-emphasis"},Ae={class:"d-flex flex-column"},Ue={class:"text-body-2 font-weight-medium"},je={class:"text-caption text-medium-emphasis"},Oe={key:0,class:"d-flex flex-wrap gap-2"},Be={key:0,class:"d-flex align-center justify-center rounded bg-grey-lighten-3",style:{height:"60px",width:"60px"}},Ne={class:"text-caption text-medium-emphasis"},Ie={key:1,class:"text-grey text-caption"},Le={class:"text-body-2 font-weight-medium text-truncate",style:{"max-width":"200px"}},Re={class:"text-body-2",style:{"max-width":"150px","white-space":"pre-wrap","word-wrap":"break-word"}},Ee={class:"d-flex gap-1"},We={class:"d-flex align-center"},He={class:"text-h5 font-weight-medium"},Ye={class:"d-flex align-center mb-3"},qe={class:"text-body-2 text-medium-emphasis mt-2"},Je={__name:"diary",setup(Qe){const v=pe(),W=f([]),j=f(""),P=f(null),O=f(!1),ae=[{title:"建立時間",key:"createdAt",sortable:!0,width:"140px"},{title:"回憶日期",key:"date",sortable:!0,width:"140px"},{title:"圖片",key:"image",sortable:!1,width:"120px"},{title:"標題",key:"title",sortable:!0,width:"200px"},{title:"內容",key:"description",sortable:!1,width:"300px"},{title:"分類",key:"category",sortable:!0,width:"100px"},{title:"狀態",key:"sell",sortable:!0,width:"100px"},{title:"操作",key:"actions",sortable:!1,width:"100px"}],B=["快樂","難過","生氣","平靜","問題","職訓局"],le=me(()=>{let l=W.value;return P.value&&(l=l.filter(t=>t.category===P.value)),l}),se=l=>({快樂:"success",問題:"warning",難過:"info",生氣:"error",平靜:"grey"})[l]||"grey",N=async()=>{O.value=!0;try{const{data:l}=await M.getAll();W.value=l.diarys}catch(l){console.error("Error fetching diarys:",l),v({text:"無法載入回憶資料",snackbarProps:{color:"error"}})}finally{O.value=!1}};N();const r=f({open:!1,id:""}),c=f({open:!1,item:null,loading:!1}),oe=f(null),m=f([]),h=f([]),H=l=>{if(l){if(r.value.id=l._id,l.date){const t=new Date(l.date),n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),p=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");_.value.value=`${n}-${e}-${i}T${p}:${y}`}else{const t=new Date,n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),p=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");_.value.value=`${n}-${e}-${i}T${p}:${y}`}if(S.value.value=l.title,D.value.value=l.description,C.value.value=l.sell,$.value.value=l.category,l.image&&l.image.length>0){const t=l.image.map((n,e)=>({name:`existing-image-${e}.jpg`,size:0,type:"image/jpeg",url:n,data:n,isExisting:!0,preview:n,hasPreview:!0,error:!1,file:null,blob:null}));m.value=t,h.value=t}else m.value=[],h.value=[]}else{r.value.id="";const t=new Date,n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),p=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");_.value.value=`${n}-${e}-${i}T${p}:${y}`,S.value.value="",D.value.value=`1. 
2. 
3. `,$.value.value="快樂",C.value.value=!0,m.value=[],h.value=[]}r.value.open=!0},I=()=>{r.value.open=!1,r.value.id="",ie(),m.value=[],h.value=[]},ne=l=>{c.value.item=l,c.value.open=!0},{handleSubmit:re,resetForm:ie,isSubmitting:L}=we({validationSchema:Ve({date:A().max(20,"日期最多只能有 20 字元"),title:A().max(50,"標題最多只能有 50 字元"),description:A().max(1e3,"最多只能有 1000 字元"),category:A().required("分類是必填的").oneOf(B,"請選擇有效的分類"),sell:he().required("是否顯示在回憶牆上，是必填的")}),initialValues:{date:new Date().toISOString(),title:"",description:`1.  
2.  
3.  `,category:"快樂",sell:!1}}),_=T("date"),S=T("title"),D=T("description"),$=T("category"),C=T("sell"),de=re(async l=>{var t,n;if(m.value.some(e=>e.error)){v({text:"請選擇有效的圖片檔案",snackbarProps:{color:"error"}});return}if(r.value.id.length===0&&m.value.length===0){v({text:"請上傳回憶錄圖片",snackbarProps:{color:"error"}});return}try{const e=new FormData;let i=l.date;if(r.value.id.length===0){const g=new Date(l.date),R=new Date;g.setSeconds(R.getSeconds()),i=g.toISOString()}e.append("date",i),e.append("title",l.title),e.append("description",l.description),e.append("sell",l.sell),e.append("category",l.category);const p=m.value.filter(g=>g.file),y=m.value.filter(g=>g.isExisting);if(p.length>0)for(const g of p)e.append("image",g.file);if(r.value.id.length>0&&y.length>0){const g=y.map(R=>R.url);e.append("existingImages",JSON.stringify(g))}await(r.value.id.length===0?M.create(e):M.update(r.value.id,e)),v({text:r.value.id?"回憶更新成功":"回憶新增成功",snackbarProps:{color:"success"}}),I(),N()}catch(e){console.error(e),v({text:((n=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:n.message)||"操作失敗，請稍後嘗試",snackbarProps:{color:"error"}})}}),ue=async l=>{var t,n;c.value.loading=!0;try{await M.delete(l),v({text:"回憶刪除成功",snackbarProps:{color:"success"}}),c.value.open=!1,N()}catch(e){console.error(e),v({text:((n=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:n.message)||"刪除失敗，請稍後嘗試",snackbarProps:{color:"error"}})}finally{c.value.loading=!1}},ce=async l=>{var t,n;if(!l.updating){l.updating=!0;try{const e=new FormData;e.append("date",l.date),e.append("title",l.title),e.append("description",l.description),e.append("sell",!l.sell),e.append("category",l.category),l.image&&l.image.length>0&&e.append("existingImages",JSON.stringify(l.image)),await M.update(l._id,e),l.sell=!l.sell,v({text:l.sell?"已設為公開":"已設為私人",snackbarProps:{color:"success"}})}catch(e){console.error(e),v({text:((n=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:n.message)||"狀態更新失敗",snackbarProps:{color:"error"}})}finally{l.updating=!1}}};return(l,t)=>{const n=ge("VueFileAgent");return k(),F(Y,null,[a(ke,{class:"pa-5",fluid:""},{default:s(()=>[a(U,{class:"mb-1"},{default:s(()=>[a(x,{cols:"12"},{default:s(()=>[o("div",Ce,[o("div",null,[o("h1",Fe,[a(w,{class:"mr-3 mb-1",icon:"mdi-book-open-variant",size:"large"}),t[14]||(t[14]=b(" 我的回憶錄 "))]),t[15]||(t[15]=o("p",{class:"text-body-1 text-medium-emphasis"}," 記錄生活中的美好時刻，分享您的快樂回憶 ",-1))]),a(V,{class:"text-none",color:"orange-darken-4",elevation:"2","prepend-icon":"mdi-plus",size:"large",onClick:t[0]||(t[0]=e=>H(null))},{default:s(()=>t[16]||(t[16]=[b(" 新增回憶 ")])),_:1,__:[16]})])]),_:1})]),_:1}),a(U,null,{default:s(()=>[a(x,{cols:"12"},{default:s(()=>[o("div",ze,[a(E,{modelValue:j.value,"onUpdate:modelValue":t[1]||(t[1]=e=>j.value=e),class:"flex-grow-1 mr-3",clearable:"",density:"comfortable","hide-details":"",placeholder:"搜尋回憶標題、內容或分類...","prepend-inner-icon":"mdi-magnify",variant:"outlined"},null,8,["modelValue"]),a(Z,{modelValue:P.value,"onUpdate:modelValue":t[2]||(t[2]=e=>P.value=e),class:"flex-shrink-0",clearable:"",density:"comfortable","hide-details":"",items:B,label:"分類篩選",style:{"min-width":"150px"},variant:"outlined"},null,8,["modelValue"])])]),_:1})]),_:1}),a(U,null,{default:s(()=>[a(x,{cols:"12"},{default:s(()=>[a(z,{class:"overflow-hidden",elevation:"2"},{default:s(()=>[a(_e,{class:"elevation-0",density:"default",headers:ae,hover:"","item-value":"_id",items:le.value,loading:O.value,search:j.value},{"item.createdAt":s(({item:e})=>[o("div",Te,[o("span",Me,u(new Date(e.createdAt).toLocaleDateString("zh-TW")),1),o("span",Pe,u(new Date(e.createdAt).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"})),1)])]),"item.date":s(({item:e})=>[o("div",Ae,[o("span",Ue,u(e.date?new Date(e.date).toLocaleDateString("zh-TW"):"-"),1),o("span",je,u(e.date?new Date(e.date).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}):"-"),1)])]),"item.image":s(({value:e})=>[e&&e.length>0?(k(),F("div",Oe,[(k(!0),F(Y,null,fe(e.slice(0,3),(i,p)=>(k(),xe(ye,{key:p,class:"rounded",cover:"",height:"100",src:i,width:"100"},null,8,["src"]))),128)),e.length>3?(k(),F("div",Be,[o("span",Ne,"+"+u(e.length-3),1)])):ve("",!0)])):(k(),F("span",Ie,"無圖片"))]),"item.title":s(({value:e})=>[o("div",Le,u(e||"無標題"),1)]),"item.description":s(({value:e})=>[o("div",Re,u(e||"無描述"),1)]),"item.category":s(({value:e})=>[a(ee,{class:"text-none",color:se(e),size:"small",variant:"tonal"},{default:s(()=>[b(u(e),1)]),_:2},1032,["color"])]),"item.sell":s(({item:e,value:i})=>[a(ee,{class:"text-none cursor-pointer",color:i?"success":"grey",loading:e.updating,size:"small",variant:"tonal",onClick:p=>ce(e)},{default:s(()=>[a(w,{class:"mr-1",icon:i?"mdi-eye":"mdi-eye-off",size:"small"},null,8,["icon"]),b(" "+u(i?"公開":"私人"),1)]),_:2},1032,["color","loading","onClick"])]),"item.actions":s(({item:e})=>[o("div",Ee,[a(V,{class:"text-none",color:"primary",icon:"mdi-pencil",size:"small",variant:"text",onClick:i=>H(e)},null,8,["onClick"]),a(V,{class:"text-none",color:"error",icon:"mdi-delete",size:"small",variant:"text",onClick:i=>ne(e)},null,8,["onClick"])])]),_:2},1032,["items","loading","search"])]),_:1})]),_:1})]),_:1})]),_:1}),a(K,{modelValue:r.value.open,"onUpdate:modelValue":t[10]||(t[10]=e=>r.value.open=e),"max-width":"700",persistent:"",scrollable:""},{default:s(()=>[a(Se,{disabled:d(L),onSubmit:be(d(de),["prevent"])},{default:s(()=>[a(z,null,{default:s(()=>[a(q,{class:"d-flex align-center justify-space-between pa-6 pb-4"},{default:s(()=>[o("div",We,[a(w,{class:"mr-3",color:r.value.id?"warning":"orange-darken-4",icon:r.value.id?"mdi-pencil":"mdi-plus",size:"large"},null,8,["color","icon"]),o("span",He,u(r.value.id?"編輯回憶":"新增回憶"),1)]),a(V,{class:"text-none",icon:"mdi-close",variant:"text",onClick:I})]),_:1}),a(te),a(J,{class:"pa-6"},{default:s(()=>[a(U,null,{default:s(()=>[a(x,{cols:"12",md:"6"},{default:s(()=>[a(E,{modelValue:d(_).value.value,"onUpdate:modelValue":t[3]||(t[3]=e=>d(_).value.value=e),density:"comfortable","error-messages":d(_).errorMessage.value,label:"日期和時間","prepend-inner-icon":"mdi-calendar-clock",type:"datetime-local",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12",md:"6"},{default:s(()=>[a(Z,{modelValue:d($).value.value,"onUpdate:modelValue":t[4]||(t[4]=e=>d($).value.value=e),density:"comfortable","error-messages":d($).errorMessage.value,items:B,label:"分類","prepend-inner-icon":"mdi-tag",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(E,{modelValue:d(S).value.value,"onUpdate:modelValue":t[5]||(t[5]=e=>d(S).value.value=e),density:"comfortable","error-messages":d(S).errorMessage.value,label:"回憶標題",placeholder:"為您的回憶取個標題...","prepend-inner-icon":"mdi-format-title",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(De,{modelValue:d(D).value.value,"onUpdate:modelValue":t[6]||(t[6]=e=>d(D).value.value=e),"auto-grow":"",density:"comfortable","error-messages":d(D).errorMessage.value,label:"每日發生的三件好事",placeholder:"記錄今天發生的三件好事...","prepend-inner-icon":"mdi-text",rows:"4",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(z,{class:"pa-4",variant:"outlined"},{default:s(()=>[o("div",Ye,[a(w,{class:"mr-2",color:"orange-darken-4",icon:"mdi-image"}),t[17]||(t[17]=o("span",{class:"text-subtitle-1 font-weight-medium"},"回憶圖片",-1))]),a(n,{ref_key:"fileAgent",ref:oe,modelValue:m.value,"onUpdate:modelValue":t[7]||(t[7]=e=>m.value=e),"raw-model-value":h.value,"onUpdate:rawModelValue":t[8]||(t[8]=e=>h.value=e),accept:"image/jpeg,image/png",deletable:"","error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 1MB"},"help-text":"選擇或拖曳圖片檔案到此處","max-files":5,"max-size":"1MB",multiple:"",theme:"grid","url-resolver":e=>e.url?e.url:e.data?e.data:e.preview?e.preview:null},null,8,["modelValue","raw-model-value","url-resolver"])]),_:1})]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(z,{class:"pa-4",variant:"outlined"},{default:s(()=>[a($e,{modelValue:d(C).value.value,"onUpdate:modelValue":t[9]||(t[9]=e=>d(C).value.value=e),class:"ma-0",color:"success","error-messages":d(C).errorMessage.value,"hide-details":"",label:"公開分享到回憶牆"},{prepend:s(()=>[a(w,{class:"mr-2",color:"success",icon:"mdi-eye"})]),_:1},8,["modelValue","error-messages"]),t[18]||(t[18]=o("p",{class:"text-caption text-medium-emphasis mt-2 mb-0"}," 開啟後，可以在回憶牆上看到您的回憶 ",-1))]),_:1,__:[18]})]),_:1})]),_:1})]),_:1}),a(te),a(Q,{class:"pa-6"},{default:s(()=>[a(G),a(V,{class:"text-none",color:"grey-darken-1",disabled:d(L),variant:"outlined",onClick:I},{default:s(()=>t[19]||(t[19]=[b(" 取消 ")])),_:1,__:[19]},8,["disabled"]),a(V,{class:"text-none",color:r.value.id?"warning":"orange-darken-4",loading:d(L),type:"submit",variant:"flat"},{default:s(()=>[a(w,{class:"mr-2",icon:r.value.id?"mdi-content-save":"mdi-plus"},null,8,["icon"]),b(" "+u(r.value.id?"儲存變更":"新增回憶"),1)]),_:1},8,["color","loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"]),a(K,{modelValue:c.value.open,"onUpdate:modelValue":t[13]||(t[13]=e=>c.value.open=e),"max-width":"400"},{default:s(()=>[a(z,null,{default:s(()=>[a(q,{class:"d-flex align-center pa-6 pb-4"},{default:s(()=>[a(w,{class:"mr-3",color:"error",icon:"mdi-alert",size:"large"}),t[20]||(t[20]=o("span",{class:"text-h6"},"確認刪除",-1))]),_:1,__:[20]}),a(J,{class:"pa-6 pt-0"},{default:s(()=>{var e;return[t[21]||(t[21]=o("p",{class:"text-body-1"}," 您確定要刪除這則回憶嗎？此操作無法復原。 ",-1)),o("p",qe," 標題："+u(((e=c.value.item)==null?void 0:e.title)||"無標題"),1)]}),_:1,__:[21]}),a(Q,{class:"pa-6 pt-0"},{default:s(()=>[a(G),a(V,{class:"text-none",color:"grey-darken-1",variant:"outlined",onClick:t[11]||(t[11]=e=>c.value.open=!1)},{default:s(()=>t[22]||(t[22]=[b(" 取消 ")])),_:1,__:[22]}),a(V,{class:"text-none",color:"error",loading:c.value.loading,onClick:t[12]||(t[12]=e=>{var i;return ue((i=c.value.item)==null?void 0:i._id)}),variant:"flat"},{default:s(()=>[a(w,{class:"mr-2",icon:"mdi-delete"}),t[23]||(t[23]=b(" 確認刪除 "))]),_:1,__:[23]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}};typeof X=="function"&&X(Je);export{Je as default};
