import{P as pe,r as v,Q as me,b as ge,l as C,o as _,d as a,w as s,e as o,p as b,f as V,h as w,aM as E,ax as F,t as u,R as fe,F as Y,n as ve,c as xe,j as ye,aN as be,k as i,ay as q,az as J,aO as Q,g as G,aP as K}from"./index-BpE4l8E1.js";import{u as Ve,c as we,a as he,b as P,e as z}from"./index.esm-DO3_2iYO.js";import{d as M}from"./diary-RVIVxxn8.js";import{b as X}from"./route-block-B_A1xBdJ.js";import{V as A,a as x}from"./VRow-CssBu1oD.js";import{b as Z,V as _e}from"./VDataTable-BeN3rWZK.js";import{V as ee}from"./VChip-DQVUrN2V.js";import{V as ke}from"./VContainer-Bp0PKZ_j.js";import{V as Se}from"./VForm-DRMmihyc.js";import{V as te}from"./VDivider-BcHjN56j.js";import{V as De}from"./VTextarea-BXcsjvZA.js";import{V as $e}from"./VSwitch-vwzR0Li7.js";import"./VPagination-CG2SNP2q.js";import"./VList-BgSJE9SD.js";import"./ssrBoot-DLccWrPe.js";import"./VMenu-Bc-rcDVZ.js";const Ce={class:"d-flex align-center justify-space-between"},Fe={class:"text-h4 font-weight-bold text-orange-darken-4 mb-1"},ze={class:"d-flex align-center gap-4 pa-1"},Me={class:"d-flex flex-column"},Te={class:"text-body-2 font-weight-medium"},Ue={class:"text-caption text-medium-emphasis"},Pe={class:"d-flex flex-column"},Ae={class:"text-body-2 font-weight-medium"},je={class:"text-caption text-medium-emphasis"},Oe={key:0,class:"d-flex flex-wrap gap-2"},Be={key:0,class:"d-flex align-center justify-center rounded bg-grey-lighten-3",style:{height:"60px",width:"60px"}},Ne={class:"text-caption text-medium-emphasis"},Ie={key:1,class:"text-grey text-caption"},Le={class:"text-body-2 font-weight-medium text-truncate",style:{"max-width":"200px"}},Re={class:"text-body-2",style:{"max-width":"150px","white-space":"pre-wrap","word-wrap":"break-word"}},Ee={class:"d-flex gap-1"},We={class:"d-flex align-center"},He={class:"text-h5 font-weight-medium"},Ye={class:"d-flex align-center mb-3"},qe={class:"text-body-2 text-medium-emphasis mt-2"},Je={__name:"diary",setup(Qe){const f=pe(),W=v([]),j=v(""),T=v(null),O=v(!1),ae=[{title:"建立時間",key:"createdAt",sortable:!0,width:"140px"},{title:"回憶日期",key:"date",sortable:!0,width:"140px"},{title:"圖片",key:"image",sortable:!1,width:"120px"},{title:"標題",key:"title",sortable:!0,width:"200px"},{title:"內容",key:"description",sortable:!1,width:"300px"},{title:"分類",key:"category",sortable:!0,width:"100px"},{title:"狀態",key:"sell",sortable:!0,width:"100px"},{title:"操作",key:"actions",sortable:!1,width:"100px"}],B=["快樂","難過","生氣","平靜","問題","職訓局"],le=me(()=>{let l=W.value;return T.value&&(l=l.filter(t=>t.category===T.value)),l}),se=l=>({快樂:"success",問題:"warning",難過:"info",生氣:"error",平靜:"grey"})[l]||"grey",N=async()=>{O.value=!0;try{const{data:l}=await M.getAll();W.value=l.diarys}catch(l){console.error("Error fetching diarys:",l),f({text:"無法載入回憶資料",snackbarProps:{color:"error"}})}finally{O.value=!1}};N();const n=v({open:!1,id:""}),c=v({open:!1,item:null,loading:!1}),oe=v(null),m=v([]),U=v([]),H=l=>{if(l){if(n.value.id=l._id,l.date){const t=new Date(l.date),d=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),p=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");h.value.value=`${d}-${e}-${r}T${p}:${y}`}else{const t=new Date,d=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),p=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");h.value.value=`${d}-${e}-${r}T${p}:${y}`}if(k.value.value=l.title,S.value.value=l.description,$.value.value=l.sell,D.value.value=l.category,l.image&&l.image.length>0){const t=l.image.map((d,e)=>({name:`existing-image-${e}.jpg`,size:0,type:"image/jpeg",url:d,isExisting:!0}));m.value=t}else m.value=[]}else{n.value.id="";const t=new Date,d=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),p=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");h.value.value=`${d}-${e}-${r}T${p}:${y}`,k.value.value="",S.value.value=`1. 
2. 
3. `,D.value.value="快樂",$.value.value=!1,m.value=[],U.value=[]}n.value.open=!0},I=()=>{n.value.open=!1,n.value.id="",ie(),m.value=[],U.value=[]},ne=l=>{c.value.item=l,c.value.open=!0},{handleSubmit:re,resetForm:ie,isSubmitting:L}=Ve({validationSchema:we({date:P().max(20,"日期最多只能有 20 字元"),title:P().max(50,"標題最多只能有 50 字元"),description:P().max(1e3,"最多只能有 1000 字元"),category:P().required("分類是必填的").oneOf(B,"請選擇有效的分類"),sell:he().required("是否顯示在回憶牆上，是必填的")}),initialValues:{date:new Date().toISOString(),title:"",description:`1.  
2.  
3.  `,category:"快樂",sell:!1}}),h=z("date"),k=z("title"),S=z("description"),D=z("category"),$=z("sell"),de=re(async l=>{var t,d;if(m.value.some(e=>e.error)){f({text:"請選擇有效的圖片檔案",snackbarProps:{color:"error"}});return}if(n.value.id.length===0&&m.value.length===0){f({text:"請上傳回憶錄圖片",snackbarProps:{color:"error"}});return}try{const e=new FormData;let r=l.date;if(n.value.id.length===0){const g=new Date(l.date),R=new Date;g.setSeconds(R.getSeconds()),r=g.toISOString()}e.append("date",r),e.append("title",l.title),e.append("description",l.description),e.append("sell",l.sell),e.append("category",l.category);const p=m.value.filter(g=>g.file),y=m.value.filter(g=>g.isExisting);if(p.length>0)for(const g of p)e.append("image",g.file);if(n.value.id.length>0&&y.length>0){const g=y.map(R=>R.url);e.append("existingImages",JSON.stringify(g))}await(n.value.id.length===0?M.create(e):M.update(n.value.id,e)),f({text:n.value.id?"回憶更新成功":"回憶新增成功",snackbarProps:{color:"success"}}),I(),N()}catch(e){console.error(e),f({text:((d=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:d.message)||"操作失敗，請稍後嘗試",snackbarProps:{color:"error"}})}}),ue=async l=>{var t,d;c.value.loading=!0;try{await M.delete(l),f({text:"回憶刪除成功",snackbarProps:{color:"success"}}),c.value.open=!1,N()}catch(e){console.error(e),f({text:((d=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:d.message)||"刪除失敗，請稍後嘗試",snackbarProps:{color:"error"}})}finally{c.value.loading=!1}},ce=async l=>{var t,d;if(!l.updating){l.updating=!0;try{const e=new FormData;e.append("date",l.date),e.append("title",l.title),e.append("description",l.description),e.append("sell",!l.sell),e.append("category",l.category),l.image&&l.image.length>0&&e.append("existingImages",JSON.stringify(l.image)),await M.update(l._id,e),l.sell=!l.sell,f({text:l.sell?"已設為公開":"已設為私人",snackbarProps:{color:"success"}})}catch(e){console.error(e),f({text:((d=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:d.message)||"狀態更新失敗",snackbarProps:{color:"error"}})}finally{l.updating=!1}}};return(l,t)=>{const d=ge("VueFileAgent");return _(),C(Y,null,[a(ke,{class:"pa-5",fluid:""},{default:s(()=>[a(A,{class:"mb-1"},{default:s(()=>[a(x,{cols:"12"},{default:s(()=>[o("div",Ce,[o("div",null,[o("h1",Fe,[a(V,{class:"mr-3 mb-1",icon:"mdi-book-open-variant",size:"large"}),t[14]||(t[14]=b(" 我的回憶錄 "))]),t[15]||(t[15]=o("p",{class:"text-body-1 text-medium-emphasis"}," 記錄生活中的美好時刻，分享您的快樂回憶 ",-1))]),a(w,{class:"text-none",color:"orange-darken-4",elevation:"2","prepend-icon":"mdi-plus",size:"large",onClick:t[0]||(t[0]=e=>H(null))},{default:s(()=>t[16]||(t[16]=[b(" 新增回憶 ")])),_:1,__:[16]})])]),_:1})]),_:1}),a(A,null,{default:s(()=>[a(x,{cols:"12"},{default:s(()=>[o("div",ze,[a(E,{modelValue:j.value,"onUpdate:modelValue":t[1]||(t[1]=e=>j.value=e),class:"flex-grow-1 mr-3",clearable:"",density:"comfortable","hide-details":"",placeholder:"搜尋回憶標題、內容或分類...","prepend-inner-icon":"mdi-magnify",variant:"outlined"},null,8,["modelValue"]),a(Z,{modelValue:T.value,"onUpdate:modelValue":t[2]||(t[2]=e=>T.value=e),class:"flex-shrink-0",clearable:"",density:"comfortable","hide-details":"",items:B,label:"分類篩選",style:{"min-width":"150px"},variant:"outlined"},null,8,["modelValue"])])]),_:1})]),_:1}),a(A,null,{default:s(()=>[a(x,{cols:"12"},{default:s(()=>[a(F,{class:"overflow-hidden",elevation:"2"},{default:s(()=>[a(_e,{class:"elevation-0",density:"default",headers:ae,hover:"","item-value":"_id",items:le.value,loading:O.value,search:j.value},{"item.createdAt":s(({item:e})=>[o("div",Me,[o("span",Te,u(new Date(e.createdAt).toLocaleDateString("zh-TW")),1),o("span",Ue,u(new Date(e.createdAt).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"})),1)])]),"item.date":s(({item:e})=>[o("div",Pe,[o("span",Ae,u(e.date?new Date(e.date).toLocaleDateString("zh-TW"):"-"),1),o("span",je,u(e.date?new Date(e.date).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}):"-"),1)])]),"item.image":s(({value:e})=>[e&&e.length>0?(_(),C("div",Oe,[(_(!0),C(Y,null,ve(e.slice(0,3),(r,p)=>(_(),xe(ye,{key:p,class:"rounded",cover:"",height:"100",src:r,width:"100"},null,8,["src"]))),128)),e.length>3?(_(),C("div",Be,[o("span",Ne,"+"+u(e.length-3),1)])):fe("",!0)])):(_(),C("span",Ie,"無圖片"))]),"item.title":s(({value:e})=>[o("div",Le,u(e||"無標題"),1)]),"item.description":s(({value:e})=>[o("div",Re,u(e||"無描述"),1)]),"item.category":s(({value:e})=>[a(ee,{class:"text-none",color:se(e),size:"small",variant:"tonal"},{default:s(()=>[b(u(e),1)]),_:2},1032,["color"])]),"item.sell":s(({item:e,value:r})=>[a(ee,{class:"text-none cursor-pointer",color:r?"success":"grey",loading:e.updating,size:"small",variant:"tonal",onClick:p=>ce(e)},{default:s(()=>[a(V,{class:"mr-1",icon:r?"mdi-eye":"mdi-eye-off",size:"small"},null,8,["icon"]),b(" "+u(r?"公開":"私人"),1)]),_:2},1032,["color","loading","onClick"])]),"item.actions":s(({item:e})=>[o("div",Ee,[a(w,{class:"text-none",color:"primary",icon:"mdi-pencil",size:"small",variant:"text",onClick:r=>H(e)},null,8,["onClick"]),a(w,{class:"text-none",color:"error",icon:"mdi-delete",size:"small",variant:"text",onClick:r=>ne(e)},null,8,["onClick"])])]),_:2},1032,["items","loading","search"])]),_:1})]),_:1})]),_:1})]),_:1}),a(K,{modelValue:n.value.open,"onUpdate:modelValue":t[10]||(t[10]=e=>n.value.open=e),"max-width":"700",persistent:"",scrollable:""},{default:s(()=>[a(Se,{disabled:i(L),onSubmit:be(i(de),["prevent"])},{default:s(()=>[a(F,null,{default:s(()=>[a(q,{class:"d-flex align-center justify-space-between pa-6 pb-4"},{default:s(()=>[o("div",We,[a(V,{class:"mr-3",color:n.value.id?"warning":"orange-darken-4",icon:n.value.id?"mdi-pencil":"mdi-plus",size:"large"},null,8,["color","icon"]),o("span",He,u(n.value.id?"編輯回憶":"新增回憶"),1)]),a(w,{class:"text-none",icon:"mdi-close",variant:"text",onClick:I})]),_:1}),a(te),a(J,{class:"pa-6"},{default:s(()=>[a(A,null,{default:s(()=>[a(x,{cols:"12",md:"6"},{default:s(()=>[a(E,{modelValue:i(h).value.value,"onUpdate:modelValue":t[3]||(t[3]=e=>i(h).value.value=e),density:"comfortable","error-messages":i(h).errorMessage.value,label:"日期和時間","prepend-inner-icon":"mdi-calendar-clock",type:"datetime-local",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12",md:"6"},{default:s(()=>[a(Z,{modelValue:i(D).value.value,"onUpdate:modelValue":t[4]||(t[4]=e=>i(D).value.value=e),density:"comfortable","error-messages":i(D).errorMessage.value,items:B,label:"分類","prepend-inner-icon":"mdi-tag",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(E,{modelValue:i(k).value.value,"onUpdate:modelValue":t[5]||(t[5]=e=>i(k).value.value=e),density:"comfortable","error-messages":i(k).errorMessage.value,label:"回憶標題",placeholder:"為您的回憶取個標題...","prepend-inner-icon":"mdi-format-title",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(De,{modelValue:i(S).value.value,"onUpdate:modelValue":t[6]||(t[6]=e=>i(S).value.value=e),"auto-grow":"",density:"comfortable","error-messages":i(S).errorMessage.value,label:"每日發生的三件好事",placeholder:"記錄今天發生的三件好事...","prepend-inner-icon":"mdi-text",rows:"4",variant:"outlined"},null,8,["modelValue","error-messages"])]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(F,{class:"pa-4",variant:"outlined"},{default:s(()=>[o("div",Ye,[a(V,{class:"mr-2",color:"orange-darken-4",icon:"mdi-image"}),t[17]||(t[17]=o("span",{class:"text-subtitle-1 font-weight-medium"},"回憶圖片",-1))]),a(d,{ref_key:"fileAgent",ref:oe,modelValue:m.value,"onUpdate:modelValue":t[7]||(t[7]=e=>m.value=e),"raw-model-value":U.value,"onUpdate:rawModelValue":t[8]||(t[8]=e=>U.value=e),accept:"image/jpeg,image/png",deletable:"","error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 1MB"},"help-text":"選擇或拖曳圖片檔案到此處","max-files":5,"max-size":"1MB",multiple:"","url-resolver":e=>e.url||e.data},null,8,["modelValue","raw-model-value","url-resolver"])]),_:1})]),_:1}),a(x,{cols:"12"},{default:s(()=>[a(F,{class:"pa-4",variant:"outlined"},{default:s(()=>[a($e,{modelValue:i($).value.value,"onUpdate:modelValue":t[9]||(t[9]=e=>i($).value.value=e),class:"ma-0",color:"success","error-messages":i($).errorMessage.value,"hide-details":"",label:"公開分享到回憶牆"},{prepend:s(()=>[a(V,{class:"mr-2",color:"success",icon:"mdi-eye"})]),_:1},8,["modelValue","error-messages"]),t[18]||(t[18]=o("p",{class:"text-caption text-medium-emphasis mt-2 mb-0"}," 開啟後，可以在回憶牆上看到您的回憶 ",-1))]),_:1,__:[18]})]),_:1})]),_:1})]),_:1}),a(te),a(Q,{class:"pa-6"},{default:s(()=>[a(G),a(w,{class:"text-none",color:"grey-darken-1",disabled:i(L),variant:"outlined",onClick:I},{default:s(()=>t[19]||(t[19]=[b(" 取消 ")])),_:1,__:[19]},8,["disabled"]),a(w,{class:"text-none",color:n.value.id?"warning":"orange-darken-4",loading:i(L),type:"submit",variant:"flat"},{default:s(()=>[a(V,{class:"mr-2",icon:n.value.id?"mdi-content-save":"mdi-plus"},null,8,["icon"]),b(" "+u(n.value.id?"儲存變更":"新增回憶"),1)]),_:1},8,["color","loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"]),a(K,{modelValue:c.value.open,"onUpdate:modelValue":t[13]||(t[13]=e=>c.value.open=e),"max-width":"400"},{default:s(()=>[a(F,null,{default:s(()=>[a(q,{class:"d-flex align-center pa-6 pb-4"},{default:s(()=>[a(V,{class:"mr-3",color:"error",icon:"mdi-alert",size:"large"}),t[20]||(t[20]=o("span",{class:"text-h6"},"確認刪除",-1))]),_:1,__:[20]}),a(J,{class:"pa-6 pt-0"},{default:s(()=>{var e;return[t[21]||(t[21]=o("p",{class:"text-body-1"}," 您確定要刪除這則回憶嗎？此操作無法復原。 ",-1)),o("p",qe," 標題："+u(((e=c.value.item)==null?void 0:e.title)||"無標題"),1)]}),_:1,__:[21]}),a(Q,{class:"pa-6 pt-0"},{default:s(()=>[a(G),a(w,{class:"text-none",color:"grey-darken-1",variant:"outlined",onClick:t[11]||(t[11]=e=>c.value.open=!1)},{default:s(()=>t[22]||(t[22]=[b(" 取消 ")])),_:1,__:[22]}),a(w,{class:"text-none",color:"error",loading:c.value.loading,onClick:t[12]||(t[12]=e=>{var r;return ue((r=c.value.item)==null?void 0:r._id)}),variant:"flat"},{default:s(()=>[a(V,{class:"mr-2",icon:"mdi-delete"}),t[23]||(t[23]=b(" 確認刪除 "))]),_:1,__:[23]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}};typeof X=="function"&&X(Je);export{Je as default};
