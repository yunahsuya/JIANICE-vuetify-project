import{c as C,o as D,w as s,d as l,e as a,p as i,f,h as c,ax as g,t as m,aN as w,i as P,aQ as U,ay as x,az as _,aP as y,g as v,R as A,aS as R,S as h,u as V}from"./index-KC8Fu95-.js";import{b as S}from"./route-block-B_A1xBdJ.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as b,a as u}from"./VRow-Js2kYVxX.js";import{a as k}from"./VSelect-CxcFQ9up.js";import{V as E}from"./VDataTable-Di4asx99.js";import{V as N}from"./VChip-PMzwQLBL.js";import{V as z}from"./VForm-Ci8mZxrG.js";import{V as O}from"./VContainer-C62bWApN.js";import"./VList-DJyRj5q_.js";import"./ssrBoot-CCrmWCSd.js";import"./VDivider-CgzjqxB6.js";import"./VMenu-B01AtdRN.js";import"./VPagination-FJlCxQ8A.js";const F={name:"AdminUsers",data(){return{users:[],loading:!1,saving:!1,deleting:!1,creating:!1,search:"",roleFilter:null,editDialog:!1,deleteDialog:!1,createDialog:!1,editingUser:null,userToDelete:null,editFormValid:!1,createFormValid:!1,showPasswords:!1,showCreatePassword:!1,showEditPassword:!1,newUser:{account:"",email:"",password:"",role:"user"},snackbar:{show:!1,message:"",color:"success"},headers:[{title:"帳號",key:"account",sortable:!0},{title:"電子郵件",key:"email",sortable:!0},{title:"角色",key:"role",sortable:!0},{title:"建立時間",key:"createdAt",sortable:!0},{title:"操作",key:"actions",sortable:!1}],roleOptions:[{title:"一般使用者",value:"user"},{title:"管理員",value:"admin"},{title:"系統管理員",value:"root"}],rules:{required:r=>!!r||"此欄位為必填",account:r=>/^[a-zA-Z0-9]{4,20}$/.test(r)||"帳號只能包含英文字母和數字，長度4-20字元",email:r=>/.+@.+\..+/.test(r)||"請輸入有效的電子郵件地址",password:r=>!r||r.length>=4&&r.length<=20||"密碼長度必須在4-20字元之間"}}},computed:{availableRoleOptions(){const r=V();return r.role==="root"?this.roleOptions:r.role==="admin"?this.roleOptions.filter(e=>e.value!=="root"):[]},rootCount(){return this.users.filter(r=>r.role==="root").length},filteredUsers(){let r=this.users;return this.roleFilter&&(r=r.filter(e=>e.role===this.roleFilter)),r},userCount(){return this.users.filter(r=>r.role==="user").length},adminCount(){return this.users.filter(r=>r.role==="admin").length},todayCount(){const r=new Date;return r.setHours(0,0,0,0),this.users.filter(e=>{const n=new Date(e.createdAt);return n.setHours(0,0,0,0),n.getTime()===r.getTime()}).length}},mounted(){this.loadUsers()},methods:{async loadUsers(){this.loading=!0;try{const r=await h.getAllUsers();this.users=r.data.result}catch(r){console.error("載入使用者失敗:",r),this.showSnackbar("載入使用者失敗","error")}finally{this.loading=!1}},canEditUser(r){const e=V();return e.role==="root"?!0:e.role==="admin"?r.role!=="root":!1},canDeleteUser(r){const e=V();return e.role==="root"||e.role==="admin"?r.role!=="root":!1},getRoleColor(r){switch(r){case"root":return"purple";case"admin":return"error";default:return"success"}},getRoleIcon(r){switch(r){case"root":return"mdi-shield-crown";case"admin":return"mdi-shield";default:return"mdi-account"}},getRoleText(r){switch(r){case"root":return"系統管理員";case"admin":return"管理員";default:return"一般使用者"}},refreshUsers(){this.loadUsers()},openCreateDialog(){this.createDialog=!0,this.resetNewUser()},closeCreateDialog(){this.createDialog=!1,this.resetNewUser(),this.showCreatePassword=!1},resetNewUser(){this.newUser={account:"",email:"",password:"",role:"user"},this.$refs.createForm&&this.$refs.createForm.resetValidation()},async createUser(){var e,n;if(!this.$refs.createForm.validate())return;if(V().role==="admin"&&this.newUser.role==="root"){this.showSnackbar("一般管理員不能建立系統管理員","error");return}this.creating=!0;try{const p=await h.createUser(this.newUser);this.users.unshift(p.data.result),this.closeCreateDialog(),this.showSnackbar("使用者建立成功","success")}catch(p){console.error("建立使用者失敗:",p),this.showSnackbar(((n=(e=p.response)==null?void 0:e.data)==null?void 0:n.message)||"建立使用者失敗","error")}finally{this.creating=!1}},editUser(r){if(!this.canEditUser(r)){this.showSnackbar("您沒有權限編輯此使用者","error");return}this.editingUser={...r,password:""},this.editDialog=!0,this.showEditPassword=!1},async saveUser(){var r,e;if(this.$refs.editForm.validate()){this.saving=!0;try{const n={...this.editingUser};n.password||delete n.password,await h.updateUser(this.editingUser._id,n);const p=this.users.findIndex(t=>t._id===this.editingUser._id);p!==-1&&(this.users[p]={...this.editingUser},n.password&&delete this.users[p].password),this.editDialog=!1,this.showSnackbar("使用者資料更新成功","success")}catch(n){console.error("更新使用者失敗:",n),this.showSnackbar(((e=(r=n.response)==null?void 0:r.data)==null?void 0:e.message)||"更新使用者失敗","error")}finally{this.saving=!1}}},confirmDelete(r){if(!this.canDeleteUser(r)){this.showSnackbar("您沒有權限刪除此使用者","error");return}this.userToDelete=r,this.deleteDialog=!0},async deleteUser(){var r,e;this.deleting=!0;try{await h.deleteUser(this.userToDelete._id),this.users=this.users.filter(n=>n._id!==this.userToDelete._id),this.deleteDialog=!1,this.showSnackbar("使用者刪除成功","success")}catch(n){console.error("刪除使用者失敗:",n),this.showSnackbar(((e=(r=n.response)==null?void 0:r.data)==null?void 0:e.message)||"刪除使用者失敗","error")}finally{this.deleting=!1}},formatDate(r){return new Date(r).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},showSnackbar(r,e="success"){this.snackbar={show:!0,message:r,color:e}}}},I={class:"d-flex align-center justify-space-between"},B={class:"text-h4 font-weight-bold text-primary mb-2"},H={class:"text-h4 font-weight-bold text-primary"},j={class:"text-h4 font-weight-bold text-success"},L={class:"text-h4 font-weight-bold text-error"},Q={class:"text-h4 font-weight-bold text-info"},W={class:"d-flex align-center"},Z={class:"text-white font-weight-bold"},G={class:"font-weight-medium"},J={class:"text-caption text-medium-emphasis"},K={class:"d-flex align-center"},M={class:"d-flex align-center"},X={class:"d-flex gap-2"},Y={class:"text-body-1 mb-4"},$={class:"text-error"},ee={class:"d-flex align-center"};function le(r,e,n,p,t,d){return D(),C(O,{class:"pa-3",fluid:""},{default:s(()=>[l(b,{class:"mb-1"},{default:s(()=>[l(u,{cols:"12"},{default:s(()=>[a("div",I,[a("div",null,[a("h1",B,[l(f,{class:"me-3",size:"32"},{default:s(()=>e[20]||(e[20]=[i("mdi-account-group")])),_:1,__:[20]}),e[21]||(e[21]=i(" 使用者管理 "))]),e[22]||(e[22]=a("p",{class:"text-body-1 text-medium-emphasis mt-3"}," 管理系統中的所有使用者帳號 ",-1))]),l(c,{class:"px-6 mb-2",color:"primary",elevation:"2","prepend-icon":"mdi-plus",size:"large",onClick:d.openCreateDialog},{default:s(()=>e[23]||(e[23]=[i(" 新增使用者 ")])),_:1,__:[23]},8,["onClick"])])]),_:1})]),_:1}),l(b,{class:"mb-6"},{default:s(()=>[l(u,{cols:"12",md:"3"},{default:s(()=>[l(g,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"primary",size:"48"},{default:s(()=>e[24]||(e[24]=[i("mdi-account-multiple")])),_:1,__:[24]}),a("h3",H,m(t.users.length),1),e[25]||(e[25]=a("p",{class:"text-body-2 text-medium-emphasis"},"總使用者數",-1))]),_:1,__:[25]})]),_:1}),l(u,{cols:"12",md:"3"},{default:s(()=>[l(g,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"success",size:"48"},{default:s(()=>e[26]||(e[26]=[i("mdi-account")])),_:1,__:[26]}),a("h3",j,m(d.userCount),1),e[27]||(e[27]=a("p",{class:"text-body-2 text-medium-emphasis"},"一般使用者",-1))]),_:1,__:[27]})]),_:1}),l(u,{cols:"12",md:"3"},{default:s(()=>[l(g,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"error",size:"48"},{default:s(()=>e[28]||(e[28]=[i("mdi-shield-crown")])),_:1,__:[28]}),a("h3",L,m(d.adminCount),1),e[29]||(e[29]=a("p",{class:"text-body-2 text-medium-emphasis"},"管理員",-1))]),_:1,__:[29]})]),_:1}),l(u,{cols:"12",md:"3"},{default:s(()=>[l(g,{class:"text-center pa-4",elevation:"2"},{default:s(()=>[l(f,{class:"mb-3",color:"info",size:"48"},{default:s(()=>e[30]||(e[30]=[i("mdi-calendar-today")])),_:1,__:[30]}),a("h3",Q,m(d.todayCount),1),e[31]||(e[31]=a("p",{class:"text-body-2 text-medium-emphasis"},"今日新增",-1))]),_:1,__:[31]})]),_:1})]),_:1}),l(b,null,{default:s(()=>[l(u,{cols:"12",md:"6"},{default:s(()=>[l(w,{modelValue:t.search,"onUpdate:modelValue":e[0]||(e[0]=o=>t.search=o),clearable:"",density:"comfortable",label:"搜尋使用者","prepend-inner-icon":"mdi-magnify",variant:"outlined"},null,8,["modelValue"])]),_:1}),l(u,{cols:"12",md:"3"},{default:s(()=>[l(k,{modelValue:t.roleFilter,"onUpdate:modelValue":e[1]||(e[1]=o=>t.roleFilter=o),clearable:"",density:"comfortable",items:t.roleOptions,label:"角色篩選",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),l(u,{class:"d-flex align-center",cols:"12",md:"3"},{default:s(()=>[l(c,{class:"w-100 mb-6",color:"primary",height:"45px",loading:t.loading,"prepend-icon":"mdi-refresh",variant:"outlined",onClick:d.refreshUsers},{default:s(()=>e[32]||(e[32]=[i(" 重新整理 ")])),_:1,__:[32]},8,["loading","onClick"])]),_:1})]),_:1}),l(b,null,{default:s(()=>[l(u,{cols:"12"},{default:s(()=>[l(g,{elevation:"2"},{default:s(()=>[l(E,{class:"elevation-0",density:"default",headers:t.headers,hover:"",items:d.filteredUsers,loading:t.loading,search:t.search},{"item.account":s(({item:o})=>[a("div",W,[l(P,{class:"me-3",color:"primary",size:"32"},{default:s(()=>[a("span",Z,m(o.account.charAt(0).toUpperCase()),1)]),_:2},1024),a("div",null,[a("div",G,m(o.account),1),a("div",J,"ID: "+m(o._id.slice(-6)),1)])])]),"item.email":s(({item:o})=>[a("div",K,[l(f,{class:"me-2",color:"grey",size:"16"},{default:s(()=>e[33]||(e[33]=[i("mdi-email")])),_:1,__:[33]}),i(" "+m(o.email),1)])]),"item.role":s(({item:o})=>[l(N,{class:"font-weight-medium",color:d.getRoleColor(o.role),size:"small",variant:"elevated"},{default:s(()=>[l(f,{class:"me-1",size:"16"},{default:s(()=>[i(m(d.getRoleIcon(o.role)),1)]),_:2},1024),i(" "+m(d.getRoleText(o.role)),1)]),_:2},1032,["color"])]),"item.createdAt":s(({item:o})=>[a("div",M,[l(f,{class:"me-2",color:"grey",size:"16"},{default:s(()=>e[34]||(e[34]=[i("mdi-calendar")])),_:1,__:[34]}),i(" "+m(d.formatDate(o.createdAt)),1)])]),"item.actions":s(({item:o})=>[a("div",X,[l(c,{class:"me-1",color:"warning",icon:"mdi-pencil",size:"small",title:"編輯使用者",variant:"tonal",disabled:!d.canEditUser(o),onClick:T=>d.editUser(o)},null,8,["disabled","onClick"]),l(c,{color:"error",icon:"mdi-delete",size:"small",title:"刪除使用者",variant:"tonal",disabled:!d.canDeleteUser(o),onClick:T=>d.confirmDelete(o)},null,8,["disabled","onClick"])])]),_:1},8,["headers","items","loading","search"])]),_:1})]),_:1})]),_:1}),l(U,{modelValue:t.createDialog,"onUpdate:modelValue":e[8]||(e[8]=o=>t.createDialog=o),"max-width":"500px",persistent:""},{default:s(()=>[l(g,null,{default:s(()=>[l(x,{class:"text-h5 font-weight-bold pa-6 pb-4"},{default:s(()=>[l(f,{class:"me-3",color:"primary",size:"28"},{default:s(()=>e[35]||(e[35]=[i("mdi-account-plus")])),_:1,__:[35]}),e[36]||(e[36]=i(" 新增使用者 "))]),_:1,__:[36]}),l(_,{class:"pa-6 pt-0"},{default:s(()=>[l(z,{ref:"createForm",modelValue:t.createFormValid,"onUpdate:modelValue":e[7]||(e[7]=o=>t.createFormValid=o)},{default:s(()=>[l(b,null,{default:s(()=>[l(u,{cols:"12",md:"6"},{default:s(()=>[l(w,{modelValue:t.newUser.account,"onUpdate:modelValue":e[2]||(e[2]=o=>t.newUser.account=o),density:"comfortable",label:"帳號 *","prepend-inner-icon":"mdi-account",rules:[t.rules.required,t.rules.account],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(u,{cols:"12",md:"6"},{default:s(()=>[l(w,{modelValue:t.newUser.email,"onUpdate:modelValue":e[3]||(e[3]=o=>t.newUser.email=o),density:"comfortable",label:"電子郵件 *","prepend-inner-icon":"mdi-email",rules:[t.rules.required,t.rules.email],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(u,{cols:"12",md:"6"},{default:s(()=>[l(w,{modelValue:t.newUser.password,"onUpdate:modelValue":e[5]||(e[5]=o=>t.newUser.password=o),density:"comfortable",label:"密碼 *","prepend-inner-icon":"mdi-lock",rules:[t.rules.required,t.rules.password],type:t.showCreatePassword?"text":"password",variant:"outlined"},{"append-inner":s(()=>[l(c,{icon:"mdi-eye",size:"small",variant:"text",onClick:e[4]||(e[4]=o=>t.showCreatePassword=!t.showCreatePassword)})]),_:1},8,["modelValue","rules","type"])]),_:1}),l(u,{cols:"12",md:"6"},{default:s(()=>[l(k,{modelValue:t.newUser.role,"onUpdate:modelValue":e[6]||(e[6]=o=>t.newUser.role=o),density:"comfortable",items:d.availableRoleOptions,label:"角色 *","prepend-inner-icon":"mdi-shield",rules:[t.rules.required],variant:"outlined"},null,8,["modelValue","items","rules"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(y,{class:"pa-6 pt-0"},{default:s(()=>[l(v),l(c,{class:"px-6",color:"grey",variant:"outlined",onClick:d.closeCreateDialog},{default:s(()=>e[37]||(e[37]=[i(" 取消 ")])),_:1,__:[37]},8,["onClick"]),l(c,{class:"px-6",color:"primary",disabled:!t.createFormValid,loading:t.creating,onClick:d.createUser},{default:s(()=>e[38]||(e[38]=[i(" 新增 ")])),_:1,__:[38]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(U,{modelValue:t.editDialog,"onUpdate:modelValue":e[16]||(e[16]=o=>t.editDialog=o),"max-width":"500px",persistent:""},{default:s(()=>[l(g,null,{default:s(()=>[l(x,{class:"text-h5 font-weight-bold pa-6 pb-4"},{default:s(()=>[l(f,{class:"me-3",color:"warning",size:"28"},{default:s(()=>e[39]||(e[39]=[i("mdi-account-edit")])),_:1,__:[39]}),e[40]||(e[40]=i(" 編輯使用者 "))]),_:1,__:[40]}),t.editingUser?(D(),C(_,{key:0,class:"pa-6 pt-0"},{default:s(()=>[l(z,{ref:"editForm",modelValue:t.editFormValid,"onUpdate:modelValue":e[14]||(e[14]=o=>t.editFormValid=o)},{default:s(()=>[l(b,null,{default:s(()=>[l(u,{cols:"12",md:"6"},{default:s(()=>[l(w,{modelValue:t.editingUser.account,"onUpdate:modelValue":e[9]||(e[9]=o=>t.editingUser.account=o),density:"comfortable",label:"帳號","prepend-inner-icon":"mdi-account",rules:[t.rules.required,t.rules.account],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(u,{cols:"12",md:"6"},{default:s(()=>[l(w,{modelValue:t.editingUser.email,"onUpdate:modelValue":e[10]||(e[10]=o=>t.editingUser.email=o),density:"comfortable",label:"電子郵件","prepend-inner-icon":"mdi-email",rules:[t.rules.required,t.rules.email],variant:"outlined"},null,8,["modelValue","rules"])]),_:1}),l(u,{cols:"12",md:"6"},{default:s(()=>[l(w,{modelValue:t.editingUser.password,"onUpdate:modelValue":e[12]||(e[12]=o=>t.editingUser.password=o),density:"comfortable",label:"新密碼 (留空則不修改)","prepend-inner-icon":"mdi-lock",rules:[t.rules.password],type:t.showEditPassword?"text":"password",variant:"outlined"},{"append-inner":s(()=>[l(c,{icon:"mdi-eye",size:"small",variant:"text",onClick:e[11]||(e[11]=o=>t.showEditPassword=!t.showEditPassword)})]),_:1},8,["modelValue","rules","type"])]),_:1}),l(u,{cols:"12",md:"6"},{default:s(()=>[l(k,{modelValue:t.editingUser.role,"onUpdate:modelValue":e[13]||(e[13]=o=>t.editingUser.role=o),density:"comfortable",items:t.roleOptions,label:"角色","prepend-inner-icon":"mdi-shield",rules:[t.rules.required],variant:"outlined"},null,8,["modelValue","items","rules"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})):A("",!0),l(y,{class:"pa-6 pt-0"},{default:s(()=>[l(v),l(c,{class:"px-6",color:"grey",variant:"outlined",onClick:e[15]||(e[15]=o=>t.editDialog=!1)},{default:s(()=>e[41]||(e[41]=[i(" 取消 ")])),_:1,__:[41]}),l(c,{class:"px-6",color:"primary",disabled:!t.editFormValid,loading:t.saving,onClick:d.saveUser},{default:s(()=>e[42]||(e[42]=[i(" 儲存 ")])),_:1,__:[42]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(U,{modelValue:t.deleteDialog,"onUpdate:modelValue":e[18]||(e[18]=o=>t.deleteDialog=o),"max-width":"400px",persistent:""},{default:s(()=>[l(g,null,{default:s(()=>[l(x,{class:"text-h5 font-weight-bold pa-6 pb-4 text-center"},{default:s(()=>[l(f,{class:"me-3",color:"error",size:"32"},{default:s(()=>e[43]||(e[43]=[i("mdi-alert-circle")])),_:1,__:[43]}),e[44]||(e[44]=i(" 確認刪除 "))]),_:1,__:[44]}),l(_,{class:"pa-6 pt-0 text-center"},{default:s(()=>{var o;return[a("p",Y,[e[45]||(e[45]=i(" 確定要刪除使用者 ")),a("strong",$,m((o=t.userToDelete)==null?void 0:o.account),1),e[46]||(e[46]=i(" 嗎？ "))]),e[47]||(e[47]=a("p",{class:"text-body-2 text-medium-emphasis"}," 此操作無法復原，請謹慎操作。 ",-1))]}),_:1,__:[47]}),l(y,{class:"pa-6 pt-0"},{default:s(()=>[l(v),l(c,{class:"px-6",color:"grey",variant:"outlined",onClick:e[17]||(e[17]=o=>t.deleteDialog=!1)},{default:s(()=>e[48]||(e[48]=[i(" 取消 ")])),_:1,__:[48]}),l(c,{class:"px-6",color:"error",loading:t.deleting,onClick:d.deleteUser},{default:s(()=>e[49]||(e[49]=[i(" 刪除 ")])),_:1,__:[49]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(R,{modelValue:t.snackbar.show,"onUpdate:modelValue":e[19]||(e[19]=o=>t.snackbar.show=o),color:t.snackbar.color,location:"top",timeout:3e3},{default:s(()=>[a("div",ee,[l(f,{class:"me-3"},{default:s(()=>[i(m(t.snackbar.color==="success"?"mdi-check-circle":"mdi-alert-circle"),1)]),_:1}),i(" "+m(t.snackbar.message),1)])]),_:1},8,["modelValue","color"])]),_:1})}typeof S=="function"&&S(F);const we=q(F,[["render",le]]);export{we as default};
